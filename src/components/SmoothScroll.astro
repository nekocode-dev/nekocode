---
/**
 * SmoothScroll Component
 * Implements Lenis for buttery-smooth scrolling with optimal performance
 * 
 * Features:
 * - Hardware-accelerated smooth scrolling
 * - Respects prefers-reduced-motion
 * - Optimized lerp and wheel multiplier settings
 * - Integrates with Astro View Transitions
 */
---

<script>
  import Lenis from 'lenis';

  let lenis: Lenis | null = null;

  function initLenis() {
    // Respect user's motion preferences
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    if (prefersReducedMotion) {
      document.documentElement.classList.add('no-smooth-scroll');
      return;
    }

    // Destroy existing instance if any (for view transitions)
    if (lenis) {
      lenis.destroy();
    }

    // Initialize Lenis with optimized settings
    lenis = new Lenis({
      duration: 1.2,           // Duration of the scroll animation
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Exponential easing
      orientation: 'vertical',
      gestureOrientation: 'vertical',
      smoothWheel: true,
      wheelMultiplier: 1,      // Default scroll speed
      touchMultiplier: 2,      // Slightly faster for touch
      infinite: false,
    });

    // Sync with requestAnimationFrame for 60fps
    function raf(time: number) {
      lenis?.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // Expose lenis to window for anchor link handling
    (window as any).lenis = lenis;

    // Handle anchor links with smooth scrolling
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', (e) => {
        const href = anchor.getAttribute('href');
        if (href && href !== '#') {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            lenis?.scrollTo(target as HTMLElement, {
              offset: -100, // Account for fixed navbar
              duration: 1.5,
            });
          }
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initLenis);
  
  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initLenis);
  document.addEventListener('astro:page-load', initLenis);
</script>

<style is:global>
  /* Lenis recommended styles */
  html.lenis,
  html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-scrolling iframe {
    pointer-events: none;
  }

  /* Fallback for reduced motion */
  html.no-smooth-scroll {
    scroll-behavior: auto !important;
  }
</style>
