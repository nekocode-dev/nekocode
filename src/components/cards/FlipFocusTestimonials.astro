---
/**
 * FlipFocusTestimonials - Premium testimonial carousel for FlipFocus
 * Fetches testimonials from Google Sheet via Apps Script API
 * Falls back to placeholder data if API unavailable
 */

interface Props {
  class?: string;
}

interface Testimonial {
  name: string;
  initials: string;
  role: string;
  rating: number;
  quote: string;
  gradient: string;
}

const { class: className } = Astro.props;

// Gradient options for testimonial cards
const gradients = [
  "linear-gradient(135deg, #F5E6D3 0%, #D4C5B0 100%)",
  "linear-gradient(135deg, #E8D5C4 0%, #C9B8A3 100%)",
  "linear-gradient(135deg, #D4C5B0 0%, #BBA896 100%)",
];

// Helper to get initials from name
function getInitials(name: string): string {
  return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

// Fallback testimonials (used if API fails or during development)
const fallbackTestimonials: Testimonial[] = [
  {
    name: "Alex Chen",
    initials: "AC",
    role: "Medical Student",
    rating: 5,
    quote: "FlipFocus transformed my USMLE prep. The FSRS algorithm helps me retain so much more!",
    gradient: gradients[0]
  },
  {
    name: "Sarah Kim",
    initials: "SK",
    role: "Language Learner",
    rating: 5,
    quote: "The most beautiful flashcard app I've used. Game modes make studying addictive!",
    gradient: gradients[1]
  },
  {
    name: "Marcus Johnson",
    initials: "MJ",
    role: "Software Developer",
    rating: 5,
    quote: "OCR scanning is a game changer. I create cards from textbooks in seconds!",
    gradient: gradients[2]
  }
];

// Fetch testimonials from Google Apps Script API
let testimonials: Testimonial[] = fallbackTestimonials;

const googleScriptUrl = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL;

if (googleScriptUrl) {
  try {
    const response = await fetch(`${googleScriptUrl}?action=get_testimonials`);
    const data = await response.json();
    
    if (data.status === 'success' && data.testimonials?.length > 0) {
      testimonials = data.testimonials.map((t: any, index: number) => ({
        name: t.name,
        initials: getInitials(t.name),
        role: t.role || '',
        rating: t.rating || 5,
        quote: t.quote,
        gradient: gradients[index % gradients.length]
      }));
    }
  } catch (error) {
    console.warn('Failed to fetch testimonials, using fallback:', error);
  }
}
---

<section class:list={["testimonials-section", className]}>
  <div class="testimonials-header reveal">
    <span class="section-badge">User Reviews</span>
    <h2 class="text-title-1">Loved by <span class="gradient-text">Learners</span></h2>
    <p class="section-subtitle">See what students and professionals are saying about FlipFocus</p>
  </div>
  
  <div class="embla" id="testimonials-embla">
    <div class="embla__viewport" id="embla-viewport">
      <div class="embla__container">
        {testimonials.map((t, index) => (
          <div class="embla__slide">
            <div class="testimonial-card">
              <div class="card-content">
                <div class="quote-mark">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                  </svg>
                </div>
                
                <p class="testimonial-quote">{t.quote}</p>
                
                <div class="testimonial-rating">
                  {[1,2,3,4,5].map(star => (
                    <svg class={`star ${star <= t.rating ? 'filled' : ''}`} width="18" height="18" viewBox="0 0 24 24" fill={star <= t.rating ? 'currentColor' : 'none'} stroke="currentColor" stroke-width="1.5">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                  ))}
                </div>
                
                <div class="testimonial-author">
                  <div class="author-avatar" style={`background: ${t.gradient}`}>
                    <span>{t.initials}</span>
                  </div>
                  <div class="author-info">
                    <span class="author-name">{t.name}</span>
                    <span class="author-role">{t.role}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
    
    <div class="embla__controls">
      <button class="embla__btn embla__btn--prev" id="embla-prev" aria-label="Previous">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      
      <div class="embla__dots" id="embla-dots"></div>
      
      <button class="embla__btn embla__btn--next" id="embla-next" aria-label="Next">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
  import EmblaCarousel from 'embla-carousel';
  
  document.addEventListener('astro:page-load', () => {
    const emblaNode = document.getElementById('embla-viewport') as HTMLElement;
    const dotsContainer = document.getElementById('embla-dots');
    const prevBtn = document.getElementById('embla-prev');
    const nextBtn = document.getElementById('embla-next');
    
    if (!emblaNode) return;
    
    // Initialize Embla
    const embla = EmblaCarousel(emblaNode, {
      loop: true,
      align: 'start',
    });
    
    // Create dots
    function createDots() {
      if (!dotsContainer) return;
      const slides = embla.scrollSnapList();
      dotsContainer.innerHTML = slides.map((_, i) => 
        `<button class="embla__dot ${i === 0 ? 'active' : ''}" aria-label="Go to slide ${i + 1}"></button>`
      ).join('');
      
      dotsContainer.querySelectorAll('.embla__dot').forEach((dot, i) => {
        dot.addEventListener('click', () => embla.scrollTo(i));
      });
    }
    
    // Update dots on scroll
    function updateDots() {
      const dots = dotsContainer?.querySelectorAll('.embla__dot');
      const selected = embla.selectedScrollSnap();
      dots?.forEach((dot, i) => {
        dot.classList.toggle('active', i === selected);
      });
    }
    
    // Button handlers
    prevBtn?.addEventListener('click', () => embla.scrollPrev());
    nextBtn?.addEventListener('click', () => embla.scrollNext());
    
    // Events
    embla.on('select', updateDots);
    embla.on('init', createDots);
    
    // Autoplay - 5 seconds
    let autoplayInterval: ReturnType<typeof setInterval> | null = null;
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    function startAutoplay() {
      if (prefersReducedMotion) return;
      autoplayInterval = setInterval(() => embla.scrollNext(), 6000); // 6 seconds - optimal for reading ~20 words
    }
    
    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    }
    
    emblaNode.addEventListener('mouseenter', stopAutoplay);
    emblaNode.addEventListener('mouseleave', startAutoplay);
    
    startAutoplay();
  });
</script>

<style>
  .testimonials-section {
    padding: var(--space-20) 0;
    position: relative;
    overflow: hidden;
  }
  
    
  .testimonials-header {
    text-align: center;
    margin-bottom: var(--space-12);
    position: relative;
    z-index: 1;
  }
  
  .section-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: rgba(var(--color-accent-rgb, 193, 154, 107), 0.15);
    border: 1px solid rgba(var(--color-accent-rgb, 193, 154, 107), 0.3);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    color: var(--color-accent);
    margin-bottom: var(--space-4);
    font-weight: 500;
  }
  
  .gradient-text {
    background: linear-gradient(135deg, var(--color-accent), #d4b896);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .section-subtitle {
    color: var(--color-muted);
    font-size: var(--text-lg);
    max-width: 500px;
    margin: var(--space-4) auto 0;
  }
  
  /* Embla Carousel - Single card view */
  .embla {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
  }
  
  .embla__viewport {
    overflow: hidden;
    padding: var(--space-4) 0;
  }
  
  .embla__container {
    display: flex;
  }
  
  .embla__slide {
    flex: 0 0 100%;
    min-width: 0;
    padding: 0 var(--space-4);
  }
  
  /* Testimonial Card - Clean readable design */
  .testimonial-card {
    position: relative;
    min-height: 280px;
    height: auto;
    padding: var(--space-6) var(--space-8);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-2xl);
    transform-style: preserve-3d;
    transform: perspective(1000px) rotateX(var(--tilt-x, 0deg)) rotateY(var(--tilt-y, 0deg));
    transition: transform 0.15s ease-out, box-shadow 0.3s ease-out, border-color 0.3s ease-out;
    will-change: transform;
    overflow: visible;
    display: flex;
    flex-direction: column;
  }
  
  .testimonial-card:hover {
    box-shadow: var(--shadow-xl);
    border-color: var(--color-accent);
  }
  
  .card-glow {
    display: none;
  }
  
  .card-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .quote-mark {
    color: var(--color-accent);
    opacity: 0.3;
    margin-bottom: var(--space-2);
    text-align: center;
  }
  
  .testimonial-quote {
    font-size: var(--text-lg);
    line-height: 1.8;
    color: var(--color-text);
    flex: 1;
    font-style: italic;
    margin-bottom: var(--space-4);
    text-align: center;
  }
  
  .testimonial-rating {
    display: flex;
    justify-content: center;
    gap: var(--space-1);
    margin: var(--space-4) 0;
  }
  
  .star {
    color: var(--color-border);
    transition: all 0.2s ease-out;
  }
  
  .star.filled {
    color: #FFD700;
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.5));
  }
  
  .testimonial-author {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }
  
  [data-theme="light"] .testimonial-author {
    border-top-color: rgba(0, 0, 0, 0.08);
  }
  
  .author-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-sm);
    color: #171717;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .author-info {
    flex: 1;
  }
  
  .author-name {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 600;
    color: var(--color-text);
    font-size: var(--text-sm);
  }
  
    
  .author-role {
    display: block;
    font-size: var(--text-xs);
    color: var(--color-muted);
    margin-top: 2px;
  }
  
  /* Carousel Controls */
  .embla__controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-6);
    margin-top: var(--space-8);
  }
  
  .embla__btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease-out;
  }
  
  .embla__btn:hover {
    background: var(--color-accent);
    color: var(--color-accent-contrast);
    border-color: var(--color-accent);
    transform: scale(1.1);
  }
  
  .embla__btn:active {
    transform: scale(0.95);
  }
  
  .embla__dots {
    display: flex;
    gap: var(--space-2);
  }
  
  .embla__dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    transition: all 0.3s ease-out;
  }
  
  .embla__dot.active {
    background: var(--color-accent);
    transform: scale(1.3);
    box-shadow: 0 0 12px rgba(var(--color-accent-rgb, 193, 154, 107), 0.5);
  }
  
  .embla__dot:hover:not(.active) {
    background: var(--color-text-secondary);
  }
  
  @media (prefers-reduced-motion: reduce) {
    .testimonial-card {
      transform: none !important;
      transition: box-shadow 0.2s ease-out;
    }
    
    .card-glow {
      display: none;
    }
  }
  
  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .testimonials-section {
      padding: var(--space-8) var(--space-4);
    }
    
    .testimonials-header h2 {
      font-size: var(--text-2xl);
    }
    
    .section-subtitle {
      font-size: var(--text-base);
    }
    
    .embla {
      max-width: 100%;
    }
    
    .embla__slide {
      padding: 0 var(--space-2);
    }
    
    .testimonial-card {
      min-height: auto;
      padding: var(--space-5) var(--space-4);
      border-radius: var(--radius-xl);
    }
    
    .quote-mark svg {
      width: 24px;
      height: 24px;
    }
    
    .testimonial-quote {
      font-size: var(--text-base);
      line-height: 1.7;
      margin-bottom: var(--space-3);
    }
    
    .testimonial-rating {
      margin: var(--space-3) 0;
    }
    
    .testimonial-author {
      padding-top: var(--space-3);
      gap: var(--space-2);
    }
    
    .author-avatar {
      width: 40px;
      height: 40px;
      font-size: var(--text-xs);
    }
    
    .author-name {
      font-size: var(--text-sm);
    }
    
    .author-role {
      font-size: 11px;
    }
    
    .embla__controls {
      margin-top: var(--space-6);
      gap: var(--space-4);
    }
    
    .embla__btn {
      width: 40px;
      height: 40px;
    }
  }
</style>
