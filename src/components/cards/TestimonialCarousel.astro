---
/**
 * TestimonialCarousel - Dynamic testimonial section
 * Loads testimonials from Google Sheets for easy management
 * 
 * Features:
 * - Auto-rotating carousel with smooth transitions
 * - Star ratings and user avatars
 * - Dark mode compatible
 * - Respects reduced motion preferences
 */

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
const googleScriptUrl = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL || '';
---

<section class:list={["testimonials-section", className]} data-script-url={googleScriptUrl}>
  <div class="testimonials-header">
    <h2 class="text-title-2">What People Say</h2>
    <p class="testimonials-subtitle">Feedback from our amazing users</p>
  </div>
  
  <div class="testimonials-carousel" id="testimonials-carousel">
    <div class="testimonials-track" id="testimonials-track">
      <!-- Testimonials will be loaded dynamically -->
      <div class="testimonial-loading">
        <div class="loading-spinner"></div>
        <span>Loading testimonials...</span>
      </div>
    </div>
    
    <div class="carousel-controls">
      <button class="carousel-btn prev" id="prev-btn" aria-label="Previous testimonial">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div class="carousel-dots" id="carousel-dots"></div>
      <button class="carousel-btn next" id="next-btn" aria-label="Next testimonial">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
  document.addEventListener('astro:page-load', () => {
    const track = document.getElementById('testimonials-track');
    const dotsContainer = document.getElementById('carousel-dots');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (!track || !dotsContainer) return;
    
    let currentIndex = 0;
    let testimonials: any[] = [];
    let autoPlayInterval: ReturnType<typeof setInterval> | null = null;
    
    // Fallback testimonials if Google Sheets fails
    const fallbackTestimonials = [
      {
        name: "Alex Chen",
        role: "Medical Student",
        avatar: "",
        rating: 5,
        quote: "FlipFocus has completely transformed how I study. The spaced repetition algorithm is incredibly effective!",
        app: "FlipFocus"
      },
      {
        name: "Sarah Kim",
        role: "Language Learner",
        avatar: "",
        rating: 5,
        quote: "I've tried many flashcard apps, but FlipFocus is by far the most intuitive and beautiful.",
        app: "FlipFocus"
      },
      {
        name: "Marcus Johnson",
        role: "Software Developer",
        avatar: "",
        rating: 4,
        quote: "Great for learning new programming concepts. The OCR feature saves me so much time!",
        app: "FlipFocus"
      }
    ];
    
    // Generate initials avatar
    function getInitials(name: string): string {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }
    
    // Generate avatar color from name
    function getAvatarColor(name: string): string {
      const colors = ['#F5E6D3', '#E8D5C4', '#D4C5B0', '#C9B8A3', '#BBA896'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }
    
    // Render star rating
    function renderStars(rating: number): string {
      return Array(5).fill(0).map((_, i) => 
        `<svg class="star ${i < rating ? 'filled' : ''}" width="16" height="16" viewBox="0 0 24 24" fill="${i < rating ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>`
      ).join('');
    }
    
    // Render testimonial card
    function renderTestimonial(t: any): string {
      const initials = getInitials(t.name);
      const avatarColor = getAvatarColor(t.name);
      
      return `
        <div class="testimonial-card glass">
          <div class="testimonial-content">
            <div class="quote-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" opacity="0.2">
                <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
              </svg>
            </div>
            <p class="testimonial-quote">${t.quote}</p>
            <div class="testimonial-rating">
              ${renderStars(t.rating)}
            </div>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar" style="background-color: ${avatarColor}">
              ${t.avatar ? `<img src="${t.avatar}" alt="${t.name}" />` : `<span>${initials}</span>`}
            </div>
            <div class="author-info">
              <span class="author-name">${t.name}</span>
              <span class="author-role">${t.role}</span>
            </div>
            ${t.app ? `<span class="testimonial-app">${t.app}</span>` : ''}
          </div>
        </div>
      `;
    }
    
    // Update carousel position
    function updateCarousel() {
      if (!track) return;
      const cards = track.querySelectorAll('.testimonial-card');
      cards.forEach((card, i) => {
        (card as HTMLElement).style.transform = `translateX(${(i - currentIndex) * 100}%)`;
        (card as HTMLElement).style.opacity = i === currentIndex ? '1' : '0.3';
      });
      
      // Update dots
      const dots = dotsContainer?.querySelectorAll('.dot');
      dots?.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }
    
    // Navigate to specific slide
    function goToSlide(index: number) {
      currentIndex = (index + testimonials.length) % testimonials.length;
      updateCarousel();
      resetAutoPlay();
    }
    
    // Auto-play functionality
    function startAutoPlay() {
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReducedMotion) return;
      
      autoPlayInterval = setInterval(() => {
        goToSlide(currentIndex + 1);
      }, 5000);
    }
    
    function resetAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
      startAutoPlay();
    }
    
    // Load testimonials from Google Sheets
    async function loadTestimonials() {
      try {
        // Try to load from Google Sheets
        const section = document.querySelector('.testimonials-section');
        const scriptUrl = section?.getAttribute('data-script-url') || '';
        
        if (scriptUrl) {
          const response = await fetch(`${scriptUrl}?action=get_testimonials`);
          if (response.ok) {
            const data = await response.json();
            if (data.testimonials && data.testimonials.length > 0) {
              testimonials = data.testimonials;
            } else {
              testimonials = fallbackTestimonials;
            }
          } else {
            testimonials = fallbackTestimonials;
          }
        } else {
          testimonials = fallbackTestimonials;
        }
      } catch (error) {
        console.log('Using fallback testimonials');
        testimonials = fallbackTestimonials;
      }
      
      // Render testimonials
      if (track) {
        track.innerHTML = testimonials.map(renderTestimonial).join('');
      }
      
      // Create dots
      if (dotsContainer) {
        dotsContainer.innerHTML = testimonials.map((_, i) => 
          `<button class="dot ${i === 0 ? 'active' : ''}" aria-label="Go to testimonial ${i + 1}"></button>`
        ).join('');
        
        // Add dot click handlers
        dotsContainer.querySelectorAll('.dot').forEach((dot, i) => {
          dot.addEventListener('click', () => goToSlide(i));
        });
      }
      
      updateCarousel();
      startAutoPlay();
    }
    
    // Event listeners
    prevBtn?.addEventListener('click', () => goToSlide(currentIndex - 1));
    nextBtn?.addEventListener('click', () => goToSlide(currentIndex + 1));
    
    // Touch/swipe support
    let touchStartX = 0;
    track?.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });
    
    track?.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        goToSlide(currentIndex + (diff > 0 ? 1 : -1));
      }
    }, { passive: true });
    
    // Pause on hover
    track?.addEventListener('mouseenter', () => {
      if (autoPlayInterval) clearInterval(autoPlayInterval);
    });
    
    track?.addEventListener('mouseleave', startAutoPlay);
    
    // Initialize
    loadTestimonials();
  });
</script>

<style>
  .testimonials-section {
    padding: var(--space-16) 0;
  }
  
  .testimonials-header {
    text-align: center;
    margin-bottom: var(--space-12);
  }
  
  .testimonials-subtitle {
    color: var(--color-muted);
    margin-top: var(--space-2);
  }
  
  .testimonials-carousel {
    position: relative;
    max-width: 700px;
    margin: 0 auto;
    overflow: hidden;
  }
  
  .testimonials-track {
    display: flex;
    position: relative;
    min-height: 280px;
  }
  
  .testimonial-card {
    position: absolute;
    width: 100%;
    padding: var(--space-8);
    border-radius: var(--radius-2xl);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    transition: 
      transform 0.5s var(--anim-ease-spring, cubic-bezier(0.22, 1.2, 0.36, 1)),
      opacity 0.4s ease-out;
    will-change: transform, opacity;
  }
  
  .testimonial-content {
    position: relative;
  }
  
  .quote-icon {
    position: absolute;
    top: -10px;
    left: -5px;
    color: var(--color-accent);
  }
  
  .testimonial-quote {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text);
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }
  
  .testimonial-rating {
    display: flex;
    gap: var(--space-1);
    padding-left: var(--space-6);
    margin-bottom: var(--space-6);
  }
  
  .star {
    color: var(--color-accent);
  }
  
  .star.filled {
    color: #FFD700;
  }
  
  .testimonial-author {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-subtle);
  }
  
  .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-accent-contrast);
    overflow: hidden;
  }
  
  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .author-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .author-name {
    font-weight: 600;
    color: var(--color-text);
  }
  
  .author-role {
    font-size: var(--text-sm);
    color: var(--color-muted);
  }
  
  .testimonial-app {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-3);
    background: var(--color-accent);
    color: var(--color-accent-contrast);
    border-radius: var(--radius-full);
    font-weight: 500;
  }
  
  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    margin-top: var(--space-8);
  }
  
  .carousel-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--duration-fast) var(--ease-out);
  }
  
  .carousel-btn:hover {
    background: var(--color-accent);
    color: var(--color-accent-contrast);
    border-color: var(--color-accent);
  }
  
  .carousel-dots {
    display: flex;
    gap: var(--space-2);
  }
  
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }
  
  .dot.active {
    background: var(--color-accent);
    transform: scale(1.25);
  }
  
  .dot:hover {
    background: var(--color-accent-hover);
  }
  
  .testimonial-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    width: 100%;
    min-height: 200px;
    color: var(--color-muted);
  }
  
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  @media (max-width: 640px) {
    .testimonials-carousel {
      padding: 0 var(--space-4);
    }
    
    .testimonial-card {
      padding: var(--space-6);
    }
    
    .testimonial-quote {
      font-size: var(--text-base);
    }
  }
  
  @media (prefers-reduced-motion: reduce) {
    .testimonial-card {
      transition: opacity 0.2s ease-out;
    }
    
    .loading-spinner {
      animation: none;
    }
  }
</style>
